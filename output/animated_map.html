<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>積算温度アニメーションマップ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100%; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // 地図初期化
        const map = L.map('map', {
            center: [36.0, 138.0],
            zoom: 5,
            minZoom: 4,
            maxZoom: 12
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 状態
        let animData = null;
        let currentPestId = 'shibatuga'; // デフォルト害虫
        let currentFrame = -1;
        let imageOverlay = null;
        const cacheBuster = '?v=' + Date.now(); // キャッシュ回避用

        // アニメーションデータをロード
        fetch('/output/animation_data.json' + cacheBuster)
            .then(r => r.json())
            .then(data => {
                animData = data;
                // 初期表示: 最新フレーム
                showFrame(data.total_frames - 1);
                // 親ページにロード完了を通知
                window.parent.postMessage({
                    type: 'animation_ready',
                    totalFrames: data.total_frames,
                    dates: data.dates,
                    yearBoundaryIndex: data.year_boundary_index,
                    pestIds: data.pest_ids
                }, '*');
            })
            .catch(err => {
                console.error('Animation data load error:', err);
            });

        // フレームを表示（等値線画像をオーバーレイ）
        function showFrame(frameIndex) {
            if (!animData) return;
            currentFrame = frameIndex;

            // 画像パス（キャッシュ回避用タイムスタンプ付き）
            const imgPath = '/output/animation_frames/' + currentPestId +
                            '/frame_' + String(frameIndex).padStart(3, '0') + '.png' + cacheBuster;

            // 境界
            const b = animData.bounds;
            const bounds = [[b.south, b.west], [b.north, b.east]];

            if (imageOverlay) {
                // 既存のオーバーレイを更新
                imageOverlay.setUrl(imgPath);
            } else {
                // 新規作成
                imageOverlay = L.imageOverlay(imgPath, bounds, {
                    opacity: 0.6,
                    interactive: false
                }).addTo(map);
            }
        }

        // 害虫を切り替え
        function changePest(pestId) {
            currentPestId = pestId;
            if (currentFrame >= 0) {
                showFrame(currentFrame);
            }
        }

        // 親ページからのメッセージを受信
        window.addEventListener('message', function(event) {
            const msg = event.data;
            if (!msg || !msg.type) return;

            if (msg.type === 'goto_frame') {
                if (animData && msg.frame >= 0 && msg.frame < animData.total_frames) {
                    showFrame(msg.frame);
                }
            } else if (msg.type === 'show_latest') {
                if (animData) {
                    showFrame(animData.total_frames - 1);
                }
            } else if (msg.type === 'change_pest') {
                changePest(msg.pestId);
            }
        });
    </script>
</body>
</html>
